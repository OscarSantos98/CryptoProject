# CryptoProject

## Table of Contents

* [Getting Started](#getting-started)
    1. [Tools and prerequisites](#tools-and-prerequisites)
    2. [Installation](#installation)
    3. [Create and set up the Database](#create-and-set-up-the-database)
    4. [Database description](#database-description)
    5. [Database explanation](#database-explanation)
    6. [Software dependencies](#software-dependencies)
    7. [API references](#api-references)
* [Build and Test](#build-and-test)
* [Contributors](#contributors)

## Getting Started

This quickstart provides the information need to set-up the backend development environment, as well as the tools and services used to support it.

### Tools and prerequisites

The following tools were used to design and develop the backend.

1. [Swagger Editor](https://editor.swagger.io/)
2. [dbdiagram](https://dbdiagram.io/)
3. [Microsoft SQL Server](https://www.microsoft.com/es-es/sql-server/sql-server-downloads)
4. [Microsoft SQL Server Management (SSMS)](https://aka.ms/ssmsfullsetup)
5. [Visual Studio](https://visualstudio.microsoft.com/fr/)
6. [POSTMAN](https://www.postman.com/)


### Installation

1. Open Git Bash terminal and run the following cmd

```
git clone https://github.com/OscarSantos98/CryptoProject.git
```

### Create and set up the Database

```
cd CryptoProject/
git checkout backend/dev
```

Then open SSMS, and select your local SQL Server, later you can connect to the Azure SQL Database that we will deploy with Terraform.

Once your server is opened, open the [CreateCryptoDB.sql](../assets/sql/CreateCryptoDB.sql) file with CTRL + O key shortcut and search it in your working directory. Or just create a new query and paste its content there.

If you have already a database called CryptoDB, first run [DeleteCryptoDB.sql](../assets/sql/DeleteCryptoDB.sql) to delete it.

When you are ready, click on execute.

![](../assets/img/sqlserver/SQL%20Server%20Create%20query.png)

After the query is completed successfully, click refresh on the Object Explorer to explore the database tables and schemas.

![](../assets/img/sqlserver/SQL%20Server%20Completed%20query.png)

The following image describes the schema and table connections.

![](../assets/db/Crypto%20DB%20Schema%20Diagram.png)

### Database description

| Table     | Field description                                                                           |
|---------------|-------------------------------------------------------------------------------------------------|
| User          | **User_id** as primary key                                                                          |
|               | **Role_id** is used as foreign key in role table                                                    |
|               | **Name** identifies user                                                                            |
|               | **Email** is the primary contact and sign-in                                                        |
|               | **Password** encrypted secret key to access to the platform                                         |
|               | **Theme_id** is used as foreign key in themes table                                                 |
|               | **receiveNotifications** defines whether the user wishes to be contacted about changes in currency  |
|               | **createdAt** date of creation of account                                                           |
| Role          | **Role_id** as primary key                                                                          |
|               | **Role_desc** is the role description name                                                          |
| User_actions  | **User_actions_id** as primary key                                                                  |
|               | **User_actions** defines an action available for a particular role                                  |
|               | **Role_id** is a foreign key from the Role table                                                    |
| Themes        | **Theme_id** as primary key                                                                         |
|               | **Theme_name** name of theme                                                                        |
| RefreshToken  | **Token_id** as primary key                                                                         |
|               | **User_id** is a foreign key from User table                                                        |
|               | **Token** encrypted value generated by the API                                                      |
|               | **Expiry_date** date when token is no longer valid                                                  |
| Crypto        | **Crypto_id** as primary key                                                                        |
|               | **User_id** is a foreign key from User table                                                        |
|               | **Couple_name** symbol that identifies crypto currency                                              |
|               | **Value** stored by the .NET Core API which comes from Bitfinex API                                 |
|               | **Last_update** date when value was updated                                                         |

### Database explanation

| Relationships                                                  | Explanation                                                                                 | Example                                                                     |
|--------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------|
| User table has a relationship **one-to-one** with refreshToken table   | One user can have only one refreshToken at a time                                               | Oscar – 65fez6f8z51fe32                                                         |
|                                                                    |                                                                                                 | Laetitia – 8fz4e5f4ze3f5ez                                                      |
| User table has a relationship **one-to-one** with Crypto table         | One user can monitor only one history of values.                                                | Oscar – 1                                                                       |
|                                                                    |                                                                                                 | Didier – 2                                                                      |
|                                                                    | *Despite of that, user can have multiple dashboards and multiple currencies in a single chart.  |                                                                                 |
|                                                                    |                                                                                                 | *History could vary from user to user as they do the request at different time  |
| User table has a relationship **one-to-one** with Role table           | One user can have only one role                                                                 | Oscar – User                                                                    |
|                                                                    |                                                                                                 | Aleksandr – Admin                                                               |
|                                                                    |                                                                                                 |                                                                                 |
| User table has a relationship **many-to-one** with Themes table        | Multiple users can have the same theme                                                          | Oscar – Dark                                                                    |
|                                                                    |                                                                                                 | Morgane – Dark                                                                |
|                                                                    |                                                                                                 |                                                                                 |
| Role table has a relationship **one-to-many** with User_actions table  | One role can have multiple user actions                                                         | Admin – update:userpassword                                                     |
|                                                                    |                                                                                                 | Admin – delete:dashboard                                                            |


### Software dependencies

* ASP.NET Core 6

#### NuGet Packages
```
<PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="6.0.5" />
<PackageReference Include="Microsoft.AspNetCore.Mvc.NewtonsoftJson" Version="6.0.5" />
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="6.0.5" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="6.0.5">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
</PackageReference>
<PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="6.0.5" />
<PackageReference Include="Swashbuckle.AspNetCore" Version="6.3.0" />
```

### API references

Crypto API

[https://docs.bitfinex.com/reference#rest-public-candles](https://docs.bitfinex.com/reference#rest-public-candles)

## DB Connection string

Before building your code, you need to add the connection string of your database. Create an appsettings.Development.json file which by default is used by launchSettings.json when you do not specify other environment.
This file is ignored by the .gitignore so you can freely put your connection there without risk to share it on your repo.
When deploying with the Pipeline it will replace the connection on appsettings.json as appsettings.Development.json does not exist in the repo.

The file should look similar to the following
```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "CryptoDB": "Server=<NAME_OF_YOUR_LOCAL_MSFT_SQL_Server>;Initial Catalog=CryptoDB;Trusted_Connection=True;"
  }
}
```

Replace <NAME_OF_YOUR_LOCAL_MSFT_SQL_Server> with the real connection.

## Update in database

If your team changes database schema you can reload the changes with the following command.

```
Scaffold-DbContext -Connection Name=CryptoDB Microsoft.EntityFrameworkCore.SqlServer -OutputDir Models -force
```

Notice **CryptoDB** is used as database name, which is the one used in appsettings.json

**Warning**: If you have added changes manually in any [Models](CryptoAPI/Models/) file you risk to loose your changes, that is why you should put your code on Controllers and Repository pattern folders.
*Existing extra classes will not be removed* so you can add classes that are not part of the database if needed.

## Build and Test

Either with .NET CLI or Visual Studio

```
cd CryptoAPI
```

```
dotnet build --configuration Release
```

```
dotnet test --configuration Release --no-build
```

## Contributors

* Oscar Santos
